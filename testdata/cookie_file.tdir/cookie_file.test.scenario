# #-- cookie_file.test.scenario --#
# source the master var file when it's there
[ -f ../.tpkg.var.master ] && source ../.tpkg.var.master
# use .tpkg.var.test for in test variable passing
[ -f .tpkg.var.test ] && source .tpkg.var.test
PRE="../.."
. ../common.sh

# set environment interfaces
ip address add 2001:db8:220:1:59de:d0f4:8769:82b8 dev lo
ip link set dev lo up

# empty cookie file
touch cookie_secrets.txt

# start unbound in the background
# start with faketime
TZ=UTC faketime -f '2019-06-05 13:39:21' $PRE/unbound -d -c ub.conf >unbound.log 2>&1 &

cat .tpkg.var.test
wait_unbound_up unbound.log

# add secret
echo ">> add_cookie_secret dd3bdf9344b678b185a6f5cb60fca715"
$PRE/unbound-control -c ub.conf add_cookie_secret dd3bdf9344b678b185a6f5cb60fca715
echo ">> add_cookie_secret 445536bcd2513298075a5d379663c962"
$PRE/unbound-control -c ub.conf add_cookie_secret 445536bcd2513298075a5d379663c962

$PRE/unbound-control -c ub.conf print_cookie_secrets > cookie_secrets.out
if ! grep -q "445536bcd2513298075a5d379663c962" cookie_secrets.out; then
	sleep 1;
	$PRE/unbound-control -c ub.conf print_cookie_secrets > cookie_secrets.out
fi
if ! grep -q "445536bcd2513298075a5d379663c962" cookie_secrets.out; then
	sleep 1;
	$PRE/unbound-control -c ub.conf print_cookie_secrets > cookie_secrets.out
fi
if ! grep -q "445536bcd2513298075a5d379663c962" cookie_secrets.out; then
	sleep 1;
	$PRE/unbound-control -c ub.conf print_cookie_secrets > cookie_secrets.out
fi
if ! grep -q "445536bcd2513298075a5d379663c962" cookie_secrets.out \
	|| ! grep -q "dd3bdf9344b678b185a6f5cb60fca715" cookie_secrets.out
	then
		cat cookie_secrets.out
		echo "Cookies did not get provisioned"
		exit 1
fi
echo ">> print_cookie_secrets"
cat cookie_secrets.out

echo ">> cookie_secrets.txt"
cat cookie_secrets.txt

# check this valid cookie before rollover
dig -b 2001:db8:220:1:59de:d0f4:8769:82b8 @2001:db8:220:1:59de:d0f4:8769:82b8 +cookie=22681ab97d52c298010000005cf7c57926556bd0934c72f8 > dig.output.1
cat dig.output.1

if grep -q "22681ab97d52c298010000005cf7c57926556bd0934c72f8" dig.output.1
then
	echo "IPv6 Query with Rolled Over Secret: Cookie matches pre-rollover"
else
	echo "IPv6 Query with Rolled Over Secret: Cookie does not match pre-rollover"
	exit 1
fi

# secret rollover
$PRE/unbound-control -c ub.conf activate_cookie_secret

$PRE/unbound-control -c ub.conf print_cookie_secrets > cookie_secrets.2
if ! grep -q "^active.*445536bcd2513298075a5d379663c962" cookie_secrets.2
then
	sleep 1
	$PRE/unbound-control -c ub.conf print_cookie_secrets > cookie_secrets.2
fi
if ! grep -q "^active.*445536bcd2513298075a5d379663c962" cookie_secrets.2
then
	sleep 1
	$PRE/unbound-control -c ub.conf print_cookie_secrets > cookie_secrets.2
fi
if ! grep -q "^active.*445536bcd2513298075a5d379663c962" cookie_secrets.2
then
	sleep 1
	$PRE/unbound-control -c ub.conf print_cookie_secrets > cookie_secrets.2
fi
if ! grep -q "^active.*445536bcd2513298075a5d379663c962" cookie_secrets.2 
then
	cat cookie_secrets.2
	echo "Cookie did not get activated"
	exit 1
fi
echo ">> activate cookie secret, printout"
cat cookie_secrets.2
echo ">> cookie_secrets.txt"
cat cookie_secrets.txt

dig -b 2001:db8:220:1:59de:d0f4:8769:82b8 @2001:db8:220:1:59de:d0f4:8769:82b8 +cookie=22681ab97d52c298010000005cf7c57926556bd0934c72f8 > dig.output.2
cat dig.output.2

if grep -q "22681ab97d52c298010000005cf7c609a6bb79d16625507a" dig.output.2
then
	echo "IPv6 Query with Rolled Over Secret: Cookie matches after rollover"
else
	echo "IPv6 Query with Rolled Over Secret: Cookie does not match after rollover"
	exit 1
fi

echo ">> drop cookie secret"
$PRE/unbound-control -c ub.conf drop_cookie_secret

$PRE/unbound-control -c ub.conf print_cookie_secrets > cookie_secrets.3
if grep -q "^staging.*dd3bdf9344b678b185a6f5cb60fca715" cookie_secrets.3
then
	sleep 1
	$PRE/unbound-control -c ub.conf print_cookie_secrets > cookie_secrets.3
fi
if grep -q "^staging.*dd3bdf9344b678b185a6f5cb60fca715" cookie_secrets.3
then
	sleep 1
	$PRE/unbound-control -c ub.conf print_cookie_secrets > cookie_secrets.3
fi
if grep -q "^staging.*dd3bdf9344b678b185a6f5cb60fca715" cookie_secrets.3
then
	sleep 1
	$PRE/unbound-control -c ub.conf print_cookie_secrets > cookie_secrets.3
fi
if grep -q "^staging.*dd3bdf9344b678b185a6f5cb60fca715" cookie_secrets.3
then
	cat cookie_secrets.3
	echo "Cookie did not get dropped"
	exit 1
fi
echo ">> drop cookie secret, printout"
cat cookie_secrets.3
echo ">> cookie_secrets.txt"
cat cookie_secrets.txt

exit 0
